name: Release CI
on:
  workflow_dispatch:
    inputs:
      release-type:
        description: 'Select release type'
        required: true
        default: 'draft'
        type: choice
        options:
          - draft
          - prerelease
          - release

jobs:
  release:
    runs-on: macos-14
    permissions:
      contents: write
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name : Retrieve Version Name
        id: version
        run: echo "version=$(<VERSION)" >> $GITHUB_OUTPUT

      - name: Print Version Name
        run: echo "release version ${{steps.version.outputs.VERSION}}"

      - name: Create GitHub Tag and Release
        uses: ncipollo/release-action@v1
        with:
          ${{ inputs.release-type }}: true
          generateReleaseNotes: true
          tag: "${{steps.version.outputs.VERSION}}"
          commit: "master"

      - name: setup-cocoapods
        uses: maxim-lobanov/setup-cocoapods@v1
        with:
          version: 1.14.3


      - name: Checkout Connect Cocoapods
        uses: actions/checkout@v4
        with:
          repository: 'tyro/connect-cocoapods'
          fetch-depth: 1
          path: connect-cocoapods
          clean: true

      - name: Bundle Install
        run: bundle install

      - name: Add connect-cocoapods repo
        run: |
          pod repo add connect-cocoapods https://${{github.actor}}:${{github.token}}@github.com/tyro/connect-cocoapods.git podspec-update

      - name: Push Pod Spec to Connect Cocoapods
        run: |
          pod repo push connect-cocoapods /home/runner/work/tyro-pay-api-ios/tyro-pay-api-ios/TyroApplePay.podspec